<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>üåë Dark Blue Reset ‚Äì Day 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0b1220; --card:#1e2a44; --text:#bfc8e6; --primary:#4f83ff; --secondary:#2f3f66; --accent:#58d3ff; --muted:#96a1c8;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
       display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;}
  #app{width:100%; max-width:900px; background:var(--card); border-radius:18px; padding:26px; box-shadow:0 20px 50px rgba(0,0,0,.45);}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
  h1{margin:0; font-size:24px}
  #progress{font-size:14px; color:var(--muted)}
  #text{font-size:18px; margin:18px 0 8px; line-height:1.7; text-align:center;}
  #subtext{font-size:15px; color:var(--muted); text-align:center;}
  #timer{font-size:40px; text-align:center; margin:12px 0 10px; letter-spacing:1px}
  #dice{font-size:90px; text-align:center; cursor:pointer; margin:8px 0}
  #result{display:none; background:var(--bg); border-radius:12px; padding:12px; margin-top:14px; text-align:left; white-space:pre-wrap}
  .buttons{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-top:14px}
  button{background:var(--primary); border:none; border-radius:12px; padding:14px; color:white; font-size:15px; cursor:pointer;}
  button.secondary{background:var(--secondary)}
  button.ghost{background:transparent; border:1px solid var(--secondary); color:var(--text)}
  button:disabled{opacity:.6; cursor:not-allowed}
  #checklist{margin-top:12px}
  .checklist-item{margin:6px 0; display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.04); border-radius:10px; padding:10px 12px;}
  .checklist-item.done{text-decoration:line-through; opacity:0.6;}
  .small{opacity:.8; font-size:15px; text-align:center;}
  .pill{display:inline-block; padding:4px 10px; background:rgba(88,211,255,.12); border:1px solid rgba(88,211,255,.25); border-radius:999px; color:#bfefff; font-size:12px}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .field{display:flex; flex-direction:column; gap:6px; margin:8px 0; background:rgba(255,255,255,0.04); padding:12px; border-radius:10px;}
  label{font-size:14px; color:var(--muted)}
  input[type="number"],input[type="text"],textarea,select{padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); color:var(--text); font-size:15px; width:100%;}
  textarea{min-height:90px; resize:vertical}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .kpi{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; font-size:14px; color:var(--muted)}
  .kpi .pill{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.12)}
  .affirm{font-size:20px; text-align:center; margin:6px 0 2px}
  .note{font-size:13px; color:var(--muted); text-align:center}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>üåë Dark Blue Reset ‚Äì Day 1</h1>
    <div id="progress">Step 1 / 26</div>
  </header>
  <div id="text"></div>
  <div id="subtext"></div>
  <div id="timer"></div>
  <div id="dice"></div>
  <div id="result"></div>
  <div id="checklist"></div>
  <div class="buttons" id="buttons"></div>
</div>

<script>
/* ===== DATA ===== */
const affirmationsArabic = ["Ana kafiya b rassi.","Ma khasnich nkon kamla bach nkon mzyana.","Kan9der ndir li 9drit lyom.","Chwiya chwiya rah mzyana.","Rassi kaystahal l7nan."];
const affirmationsEnglish = ["You are enough as you are.","Your worth is not based on others.","You are capable of achieving your goals.","Progress is progress, no matter how small.","Be kind to yourself today."];
const energyStops = ["üçé Kouli fakiha","ü•ú Kouli chwiya nuts","üíß Chrbi lma","üå¨Ô∏è Tanfos 3 dqaye9"];
const baseFocusSubjects = [
  { name:"üîµ Job Search", checklist:[
    "Explore Moroccan freelancing platforms and profiles",
    "See how BI/data engineers promote their skills",
    "Identify 1‚Äì2 projects to work on for portfolio",
    "Check LinkedIn/Indeed for job postings / required skills"
  ]},
  { name:"üü£ Skill Improvement", checklist:[
    "Review job description for BI/data engineer",
    "Identify 1‚Äì2 key skills to learn",
    "Small hands-on task (SQL, Python, visualization)",
    "Document what you learned"
  ]},
  { name:"üü¢ Problem Solving (DSA)", checklist:[
    "Pick 1 DSA problem",
    "Understand problem requirements",
    "Plan brute-force solution",
    "Optimize solution",
    "Note confusion points"
  ]}
];
/* Put your own questions here; one will randomly appear between focus sessions */
const knowledgeQuestions = [
  "Why do databases use indexes and how do they speed up queries?",
  "What‚Äôs the difference between synchronous and asynchronous programming?",
  "Explain normalization vs denormalization with examples.",
  "What is a RESTful API and how does it differ from RPC?",
  "What does Big O notation tell you about an algorithm?",
  "What‚Äôs the difference between a JOIN and a UNION in SQL?",
  "What is a cache? Give 2 real-world examples in software.",
  "What is the difference between structured, semi-structured, and unstructured data?",
  "How do you handle missing values in a dataset?",
  "What is the difference between a primary key and a foreign key in a database?",
  "What is data normalization, and why is it important?",
  "How would you detect outliers in a dataset?",
"What is the difference between OLAP and OLTP?",
"How would you choose KPIs for a sales dashboard?",
"What is a star schema, and why is it used in BI?",
"How can data visualization improve decision-making?",
"Explain the difference between a bar chart, line chart, and heatmap ‚Äî when to use each."];

const curiosityPrompts = [
  "What would happen if humans could photosynthesize like plants?",
  "Why do some animals see colors differently than humans?",
  "How do trees ‚Äútalk‚Äù to each other underground ?",
  "Pick a random tech acronym you saw today. What does it stand for and why does it matter?"
];
const reflectionQuestions = [
  "How did you feel (energy, focus, emotion)?",
  "What worked well? What would you change next time?",
  "Any blockers? How will you unblock them tomorrow?"
];
const moodMiniTasks = [
  "üëÄ Look away from screen for 20 seconds",
  "üßò 3 deep breaths",
  "üö∞ Sip water",
  "ü§∏ Quick shoulder roll",
  "üôÇ Smile for 10 seconds"
];

/* ===== STATE ===== */
let stepIndex = 0;
let timer = null, timerPaused = false, timerRemaining = 0;
let focusHours = 4;
let diceResult = null; // subject name -> percent
let notes = [];
let dayMeta = {
  startTs: new Date().toISOString(),
  userProfile: {},
  focusHours: 4,
  customSubjects: [],
  dice: null
};
let currentAffirmationIx = 0;
let mainFlowLocked = false;

/* Focus sessions waves */
let sessions = [];            // [{name, checklist, minutes, id}]
let waves = { morning:[], afternoon:[], night:[] };
let runningQueue = [];        // sequence of sessions to run in a wave
let runningIndex = -1;
let blockAccumMinutes = 0;    // to enforce <= 120 minutes continuous focus

/* Actual time tracking per session */
let activeSession = null;     // {id, name, startTs, plannedMinutes}
let sessionLogs = [];         // [{id, name, plannedMinutes, actualSeconds, status}]

/* ===== HELPERS ===== */
function setProgress(){ document.getElementById("progress").innerText = `Step ${Math.min(stepIndex,26)} / 26`; }
function clearUI(){
  document.getElementById("text").innerHTML = "";
  document.getElementById("subtext").innerHTML = "";
  document.getElementById("timer").innerHTML = "";
  document.getElementById("dice").innerHTML = "";
  const res=document.getElementById("result"); res.style.display="none"; res.innerHTML="";
  document.getElementById("checklist").innerHTML = "";
  document.getElementById("buttons").innerHTML = "";
}
function render({text="", subtext="", buttons=[], showDice=false, resultHTML=null}){
  clearUI(); setProgress();
  document.getElementById("text").innerHTML = text;
  document.getElementById("subtext").innerHTML = subtext;
  if (showDice) document.getElementById("dice").innerText = "üé≤";
  if (resultHTML){ const res=document.getElementById("result"); res.style.display="block"; res.innerHTML = resultHTML; }
  const btnWrap=document.getElementById("buttons");
  buttons.forEach(b=>{
    const btn=document.createElement("button");
    btn.innerText=b.label;
    if (b.variant==="secondary") btn.classList.add("secondary");
    if (b.variant==="ghost") btn.classList.add("ghost");
    btn.onclick=()=>b.action&&b.action();
    btnWrap.appendChild(btn);
  });
}
function button(label, action, variant){
  const b=document.createElement("button");
  b.innerText=label;
  if (variant==="secondary") b.classList.add("secondary");
  if (variant==="ghost") b.classList.add("ghost");
  b.onclick=action;
  return b;
}
function formatMinSec(sec){ const m=Math.floor(sec/60), s=sec%60; return `${m}:${s.toString().padStart(2,"0")}`; }
function addNote(entry){ notes.push({ ts:new Date().toISOString(), step:stepIndex, ...entry }); }
function randomEnergy(){ return energyStops[Math.floor(Math.random()*energyStops.length)]; }
function randomCuriosity(){ return curiosityPrompts[Math.floor(Math.random()*curiosityPrompts.length)]; }
function randomMoodMini(){ return moodMiniTasks[Math.floor(Math.random()*moodMiniTasks.length)]; }
function randomKnowledgeQuestion(){ return knowledgeQuestions[Math.floor(Math.random()*knowledgeQuestions.length)]; }

/* ===== TIMER ===== */
function stopTimer(){ if (timer){ clearInterval(timer); timer=null; } }
function startTimer(minutes, onEnd){
  stopTimer();
  timerRemaining=Math.round(minutes*60); timerPaused=false;
  const timerEl=document.getElementById("timer");
  timerEl.innerText=formatMinSec(timerRemaining);
  const btnWrap=document.getElementById("buttons");
  const pauseBtn=document.createElement("button");
  pauseBtn.innerText="‚è∏Ô∏è Pause"; pauseBtn.classList.add("secondary");
  pauseBtn.onclick=()=>{ if(!timer) return; timerPaused=!timerPaused; pauseBtn.innerText=timerPaused?"‚ñ∂Ô∏è Resume":"‚è∏Ô∏è Pause"; };
  const skipBtn=document.createElement("button");
  skipBtn.innerText="‚è≠Ô∏è Skip / Next"; skipBtn.classList.add("ghost");
  skipBtn.onclick=()=>{ stopTimer(); onEnd&&onEnd("skipped"); };
  btnWrap.prepend(skipBtn); btnWrap.prepend(pauseBtn);
  timer=setInterval(()=>{
    if(!timerPaused){
      timerRemaining--;
      timerEl.innerText=formatMinSec(Math.max(timerRemaining,0));
      if (timerRemaining<=0){ stopTimer(); onEnd&&onEnd("completed"); }
    }
  },1000);
}

/* ===== REFLECTION (twice: morning and afternoon) ===== */
function askReflection(tag, afterSubmit){
  clearUI(); setProgress();
  const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
  const title = tag === "morning" ? `üìù Morning reflection${her}` : `üìù Afternoon reflection${her}`;
  document.getElementById("text").innerHTML = title;
  document.getElementById("subtext").innerHTML = "Answer briefly. This helps improve the next plan.";
  const wrap=document.getElementById("checklist");
  reflectionQuestions.forEach((q,i)=>{
    const div=document.createElement("div"); div.className="field";
    div.innerHTML=`<label>${q}</label><textarea id="ref-q-${i}"></textarea>`;
    wrap.appendChild(div);
  });
  // One curiosity prompt after morning reflection only
  let prompt = "";
  if (tag === "morning"){
    prompt = randomCuriosity();
    const cd=document.createElement("div"); cd.className="field";
    cd.innerHTML=`<label>üéØ Curiosity: ${prompt}<br><span class="note">Take 2‚Äì5 minutes to research and summarize.</span></label><textarea id="curiosity"></textarea>`;
    wrap.appendChild(cd);
  }
  const btns=document.getElementById("buttons");
  btns.appendChild(button("Skip", ()=>afterSubmit&&afterSubmit(), "secondary"));
  btns.appendChild(button("Save & Continue", ()=>{
    const answers=reflectionQuestions.map((q,i)=>({q, a:(document.getElementById(`ref-q-${i}`).value||"").trim()}));
    addNote({type:`reflection-${tag}`, title:title, content: answers});
    if (tag === "morning"){
      const cur=(document.getElementById("curiosity").value||"").trim();
      addNote({type:"curiosity", title:"Curiosity", content: cur, meta:{prompt}});
    }
    afterSubmit&&afterSubmit();
  }));
}

/* ===== PROFILE ===== */
function askProfile(onDone){
  render({ text:"üëã Welcome! Let‚Äôs personalize your day.", subtext:"These details help adjust timings and suggestions." });
  const c=document.getElementById("checklist");
  const row=document.createElement("div"); row.className="grid2";
  row.innerHTML = `
    <div class="field"><label>Your name (optional)</label><input type="text" id="name"></div>
    <div class="field"><label>Energy level now (1-10)</label><input type="number" id="energy" min="1" max="10" value="6"></div>
    <div class="field"><label>Total focus hours for main block</label><input type="number" id="focusHours" min="1" max="10" value="4"></div>
    <div class="field"><label>Today‚Äôs main priority</label><input type="text" id="priority" placeholder="e.g., Portfolio, Job search, DSA"></div>
  `;
  c.appendChild(row);
  document.getElementById("buttons").appendChild(button("Continue", ()=>{
    const name=(document.getElementById("name").value||"").trim();
    const energy=Number(document.getElementById("energy").value||6);
    const fh=Number(document.getElementById("focusHours").value||4);
    const priority=(document.getElementById("priority").value||"").trim();
    focusHours=Math.max(1, Math.min(10, fh));
    dayMeta.userProfile={name, energy, priority}; dayMeta.focusHours=focusHours;
    addNote({type:"profile", title:"Profile", content: dayMeta.userProfile});
    onDone&&onDone();
  }));
}

/* ===== PLANNING (with custom subjects) ===== */
function showPlanningForm(onDone){
  const c=document.getElementById("checklist");
  const f1=document.createElement("div"); f1.className="field";
  f1.innerHTML=`<label>Key commitments today (time blocks)</label><textarea id="plan-commit"></textarea>`;
  const f2=document.createElement("div"); f2.className="field";
  f2.innerHTML=`<label>Rest & breaks reserved (describe)</label><textarea id="plan-rest"></textarea>`;
  const f3=document.createElement("div"); f3.className="field";
  f3.innerHTML=`<label>Top 3 outcomes for today</label><textarea id="plan-outcomes"></textarea>`;
  c.appendChild(f1); c.appendChild(f2); c.appendChild(f3);

  const wrapper=document.createElement("div"); wrapper.className="field";
  wrapper.innerHTML=`<label>Add your focus subjects (optional)</label>`;
  const list=document.createElement("div"); list.id="custom-list";
  const addRow=document.createElement("div"); addRow.className="row";
  addRow.innerHTML=`
    <input type="text" id="cs-name" placeholder="Subject name (e.g., üü° Portfolio)">
    <textarea id="cs-tasks" placeholder="Checklist items, one per line"></textarea>
  `;
  const addBtn=button("Add Subject", ()=>{
    const name=(document.getElementById("cs-name").value||"").trim();
    const tasks=(document.getElementById("cs-tasks").value||"").split("\n").map(s=>s.trim()).filter(Boolean);
    if(!name || tasks.length===0) return;
    dayMeta.customSubjects.push({name, checklist:tasks});
    renderCustomList(list);
    document.getElementById("cs-name").value=""; document.getElementById("cs-tasks").value="";
  });
  addBtn.classList.add("secondary");
  wrapper.appendChild(addRow); wrapper.appendChild(addBtn); wrapper.appendChild(list);
  c.appendChild(wrapper);
  renderCustomList(list);

  document.getElementById("buttons").appendChild(button("Save & Continue", ()=>{
    const commit=(document.getElementById("plan-commit").value||"").trim();
    const rest=(document.getElementById("plan-rest").value||"").trim();
    const outcomes=(document.getElementById("plan-outcomes").value||"").trim();
    addNote({type:"planning", title:"Plan details", content: {commit, rest, outcomes}});
    onDone&&onDone();
  }));
}
function renderCustomList(container){
  container.innerHTML="";
  if (dayMeta.customSubjects.length===0){ container.innerHTML=`<div class="note">No custom subjects added yet.</div>`; return; }
  dayMeta.customSubjects.forEach((s,idx)=>{
    const item=document.createElement("div"); item.className="checklist-item";
    item.innerHTML=`<span>${s.name} ‚Äî ${s.checklist.length} items</span>`;
    const rm=button("Remove", ()=>{ dayMeta.customSubjects.splice(idx,1); renderCustomList(container); }, "ghost");
    item.appendChild(rm); container.appendChild(item);
  });
}

/* ===== AFFIRMATIONS (clean flow) ===== */
function showAffirmations(onDone){
  const ix = currentAffirmationIx;
  const isLast = ix >= affirmationsArabic.length - 1;
  const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
  render({
    text:"‚ú® Affirmation" + her,
    subtext:`<div class="affirm">${affirmationsArabic[ix]}</div><div class="note">${affirmationsEnglish[ix]}</div>`,
    buttons:[{
      label: isLast ? "Continue" : "Next affirmation",
      action: ()=>{
        currentAffirmationIx++;
        if (currentAffirmationIx < affirmationsArabic.length){
          showAffirmations(onDone);
        } else {
          setTimeout(()=> onDone && onDone(), 0);
        }
      }
    }]
  });
}

/* ===== DICE / ALLOCATION ===== */
function allocatePercents(subjects){
  const w=subjects.map(()=>Math.random()+0.1);
  const sum=w.reduce((a,b)=>a+b,0);
  const raw=w.map(x=>x/sum*100);
  const ints=raw.map(x=>Math.floor(x));
  let rem=100-ints.reduce((a,b)=>a+b,0);
  const frac=raw.map((x,i)=>({i, f:x-ints[i]})).sort((a,b)=>b.f-a.f);
  for(let k=0;k<rem;k++){ ints[frac[k%frac.length].i]++; }
  for(let i=0;i<ints.length;i++){ if(ints[i]===0) ints[i]=1; }
  let total=ints.reduce((a,b)=>a+b,0);
  while(total>100){ for(let i=0;i<ints.length && total>100;i++){ if(ints[i]>1){ ints[i]--; total--; } } }
  return ints;
}

/* ===== BUILD SESSIONS & WAVES ===== */
let sessionIdCounter = 1;
function clampSessionMinutes(mins){
  // enforce min 25, max 50; if over 50 split into multiple chunks
  const out=[];
  if (mins <= 25) { out.push(25); return out; }
  if (mins <= 50) { out.push(mins); return out; }
  let remaining = mins;
  while (remaining > 50){ out.push(50); remaining -= 50; }
  if (remaining > 0) out.push(Math.max(25, remaining));
  return out;
}
function buildSessionsFromDice(){
  const all=[...baseFocusSubjects, ...dayMeta.customSubjects];
  const perc=allocatePercents(all);
  diceResult={}; // subject -> percent
  sessions=[];
  for(let i=0;i<all.length;i++){
    const p = perc[i];
    diceResult[all[i].name] = p;
    const totalMins = Math.round(dayMeta.focusHours*60*p/100);
    const chunks = clampSessionMinutes(totalMins);
    chunks.forEach(m => sessions.push({ id: sessionIdCounter++, name: all[i].name, checklist: all[i].checklist, minutes: m }));
  }
  dayMeta.dice = diceResult;
}
function distributeWaves(){
  // Split sessions into 3 waves (morning, afternoon, night)
  waves = { morning:[], afternoon:[], night:[] };
  sessions.forEach((s, idx)=>{
    const mod = idx % 3;
    if (mod === 0) waves.morning.push(s);
    else if (mod === 1) waves.afternoon.push(s);
    else waves.night.push(s);
  });
}

/* ===== KNOWLEDGE QUESTION INJECTION ===== */
function askKnowledgeQuestion(continueFn){
  const q = randomKnowledgeQuestion();
  render({
    text: "üîé Quick question",
    subtext: `<div class="note">${q}</div>`
  });
  const c=document.getElementById("checklist");
  const f=document.createElement("div"); f.className="field";
  f.innerHTML=`<label>Your short answer</label><textarea id="kq"></textarea>`;
  c.appendChild(f);
  document.getElementById("buttons").appendChild(button("Skip", continueFn, "secondary"));
  document.getElementById("buttons").appendChild(button("Save & Continue", ()=>{
    const ans=(document.getElementById("kq").value||"").trim();
    addNote({type:"knowledge", title:"Knowledge Question", content: {question:q, answer:ans}});
    continueFn && continueFn();
  }));
}

/* ===== RUNNING A WAVE (<=2h continuous focus + random questions) ===== */
function showFocusIntro(session, onStart){
  const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
  render({
    text: `${session.name}${her}`,
    subtext: `<div class="affirm">${affirmationsEnglish[currentAffirmationIx % affirmationsEnglish.length]}</div><div class="note">${session.minutes} minutes ‚Ä¢ Click Start to view checklist and timer.</div>`
  });
  document.getElementById("buttons").appendChild(button(`Start ${session.name}`, onStart));
}
function renderFocus(session, onFinish){
  const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
  document.getElementById("text").innerHTML = `${session.name}${her} <br><span class="small">${session.minutes} minutes</span>`;
  document.getElementById("subtext").innerHTML = "";
  document.getElementById("checklist").innerHTML = "";
  document.getElementById("buttons").innerHTML = "";
  const status = Array(session.checklist.length).fill(false);
  session.checklist.forEach((item,i)=>{
    const div=document.createElement("div"); div.className="checklist-item";
    const span=document.createElement("span"); span.innerText=item;
    const btn=document.createElement("button"); btn.innerText="‚úîÔ∏è";
    btn.onclick=()=>{ status[i]=!status[i]; div.classList.toggle("done", status[i]); btn.innerText=status[i]?"‚úÖ":"‚úîÔ∏è"; };
    div.appendChild(span); div.appendChild(btn);
    document.getElementById("checklist").appendChild(div);
  });
  const saveBtn=button("Save Checklist", ()=> addNote({type:"checklist", title:`${session.name} checklist`, content: session.checklist.map((t)=>({task:t})) }));
  const skipBtn=button("‚è≠Ô∏è Skip Focus", ()=>{ finalizeSession(session, "skipped"); onFinish&&onFinish(); }, "secondary");
  document.getElementById("buttons").appendChild(saveBtn);
  document.getElementById("buttons").appendChild(skipBtn);
}
function startSessionTimer(session, doneCb){
  // Begin session actual-time tracking and timer
  activeSession = { id: session.id, name: session.name, plannedMinutes: session.minutes, startTs: Date.now() };
  startTimer(session.minutes, (status)=>{
    finalizeSession(session, status);
    doneCb && doneCb();
  });
}
function finalizeSession(session, status){
  stopTimer();
  const endTs = Date.now();
  let actualSeconds = 0;
  if (activeSession && activeSession.id === session.id){
    actualSeconds = Math.max(0, Math.round((endTs - activeSession.startTs)/1000));
  }
  sessionLogs.push({
    id: session.id, name: session.name,
    plannedMinutes: session.minutes,
    actualSeconds,
    status: status === "completed" ? "completed" : "skipped"
  });
  activeSession = null;
}
function runWave(queue, onDone){
  runningQueue = queue.slice();
  runningIndex = -1;
  blockAccumMinutes = 0;

  const runNext = ()=>{
    runningIndex++;
    if (runningIndex >= runningQueue.length){ onDone&&onDone(); return; }
    const sess = runningQueue[runningIndex];

    // Enforce <= 120 minutes continuous focus (2h)
    if (blockAccumMinutes + sess.minutes > 120 && blockAccumMinutes > 0){
      blockAccumMinutes = 0;
      // Insert break (energy) before proceeding
      render({ text: "‚è∏Ô∏è Short break", subtext:`<span class="note">${randomEnergy()} ‚Ä¢ ${randomMoodMini()}</span>`, buttons:[{label:"Continue", action: runNext}] });
      return;
    }

    showFocusIntro(sess, ()=>{
      renderFocus(sess, ()=>{ afterOneSession(); });
      startSessionTimer(sess, ()=>{ afterOneSession(); });
    });
  };

  const afterOneSession = ()=>{
    blockAccumMinutes += runningQueue[runningIndex].minutes;

    // Randomly show either a mood mini-task or a knowledge question between sessions (not after last)
    if (runningIndex < runningQueue.length - 1){
      const roll = Math.random();
      if (roll < 0.33){
        askKnowledgeQuestion(runNext);
      } else {
        render({ text: randomMoodMini(), buttons:[{label:"Next", action: runNext}] });
      }
    } else {
      runNext();
    }
  };

  runNext();
}

/* ===== JOURNALING / EOD ===== */
function journalingForm(title, onDone){
  const c=document.getElementById("checklist");
  const f=document.createElement("div"); f.className="field";
  f.innerHTML=`<label>${title}</label><textarea id="journal"></textarea>`;
  c.appendChild(f);
  document.getElementById("buttons").appendChild(button("Save & Continue", ()=>{
    const txt=(document.getElementById("journal").value||"").trim();
    addNote({type:"journal", title, content: txt});
    onDone&&onDone();
  }));
}
function endOfDayForm(onDone){
  const c=document.getElementById("checklist");
  const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
  const f1=document.createElement("div"); f1.className="field";
  f1.innerHTML=`<label>Gratitude (3 items)${her}</label><textarea id="eod-grat"></textarea>`;
  const f2=document.createElement("div"); f2.className="field";
  f2.innerHTML=`<label>Lessons learned</label><textarea id="eod-lessons"></textarea>`;
  const f3=document.createElement("div"); f3.className="field";
  f3.innerHTML=`<label>Plan for tomorrow</label><textarea id="eod-plan"></textarea>`;
  c.appendChild(f1); c.appendChild(f2); c.appendChild(f3);
  document.getElementById("buttons").appendChild(button("Save & Finish", ()=>{
    const grat=(document.getElementById("eod-grat").value||"").trim();
    const lessons=(document.getElementById("eod-lessons").value||"").trim();
    const plan=(document.getElementById("eod-plan").value||"").trim();
    addNote({type:"eod", title:"End of day", content: {grat, lessons, plan}});
    onDone&&onDone();
  }));
}

/* ===== DOWNLOAD (Readable Report with actual timing) ===== */
function formatQA(title, qaArray){
  const lines = [];
  lines.push(title);
  qaArray.forEach(x=>{
    lines.push(`- Question: ${x.q}`);
    lines.push(`  Response: ${x.a || "(no response)"}`);
  });
  lines.push("");
  return lines.join("\n");
}
function buildTxtSummary(){
  const lines=[];
  lines.push("Dark Blue Reset ‚Äì Day 1");
  lines.push(`Date: ${new Date().toLocaleString()}`);

  // Profile
  if (dayMeta.userProfile){
    lines.push("");
    lines.push("Profile");
    lines.push(`- Name: ${dayMeta.userProfile.name || "-"}`);
    lines.push(`- Energy: ${dayMeta.userProfile.energy ?? "-"}`);
    lines.push(`- Priority: ${dayMeta.userProfile.priority || "-"}`);
    lines.push(`- Focus Hours (planned): ${dayMeta.focusHours}`);
  }

  // Subjects
  if (dayMeta.customSubjects?.length){
    lines.push("");
    lines.push("Custom Subjects");
    dayMeta.customSubjects.forEach(s=>lines.push(`- ${s.name} (${s.checklist.length} checklist items)`));
  }

  // Allocation
  if (dayMeta.dice){
    lines.push("");
    lines.push("Focus Allocation (Dice)");
    Object.keys(dayMeta.dice).forEach(k=>lines.push(`- ${k}: ${dayMeta.dice[k]}%`));
  }

  // Session timing
  if (sessionLogs.length){
    lines.push("");
    lines.push("Focus Sessions (Planned vs Actual)");
    sessionLogs.forEach(s=>{
      const actualMin = (s.actualSeconds/60).toFixed(1);
      lines.push(`- ${s.name}: planned ${s.plannedMinutes} min, actual ${actualMin} min (${s.status})`);
    });
  }

  // Morning reflection
  const morning = notes.find(n=>n.type==="reflection-morning");
  if (morning){
    lines.push("");
    lines.push(formatQA("Morning Reflection", morning.content));
  }
  // Afternoon reflection
  const afternoon = notes.find(n=>n.type==="reflection-afternoon");
  if (afternoon){
    lines.push(formatQA("Afternoon Reflection", afternoon.content));
  }

  // Knowledge Q&A
  const knowledge = notes.filter(n=>n.type==="knowledge");
  if (knowledge.length){
    lines.push("Knowledge Questions");
    knowledge.forEach((k,i)=>{
      lines.push(`- Q: ${k.content.question}`);
      lines.push(`  A: ${k.content.answer || "(no answer)"}`);
    });
    lines.push("");
  }

  // Curiosity
  const curios = notes.filter(n=>n.type==="curiosity");
  if (curios.length){
    lines.push("Curiosity");
    curios.forEach((c,i)=>{
      if (c.meta?.prompt){
        lines.push(`- Prompt: ${c.meta.prompt}`);
      }
      lines.push(`  Response: ${c.content || "(no response)"}`);
    });
    lines.push("");
  }

  // Journals
  const journals = notes.filter(n=>n.type==="journal");
  if (journals.length){
    lines.push("Journals");
    journals.forEach(j=>{
      lines.push(`- ${j.title}:`);
      lines.push(`  ${j.content || "(no entry)"}`);
    });
    lines.push("");
  }

  // End of day
  const eod = notes.find(n=>n.type==="eod");
  if (eod){
    lines.push("End of Day");
    lines.push(`- Gratitude: ${eod.content.grat || "-"}`);
    lines.push(`- Lessons: ${eod.content.lessons || "-"}`);
    lines.push(`- Plan for tomorrow: ${eod.content.plan || "-"}`);
    lines.push("");
  }
  lines.push("Summary generated by Dark Blue Reset");
  return lines.join("\n");
}
function showDownload(){
  clearUI(); setProgress();
  const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
  document.getElementById("text").innerHTML="üåô Bravo! Nhark kaml b wa3i" + her + ". Tsb7i 3la khir üåô";
  document.getElementById("subtext").innerHTML="Download your daily report.";
  const content=buildTxtSummary();
  const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=`dark-blue-reset-day1-${new Date().toISOString().slice(0,10)}.txt`;
  a.innerText="‚¨áÔ∏è Download report (.txt)";
  a.className="pill"; a.style.display="inline-block"; a.style.margin="8px auto"; a.style.textAlign="center";
  const res=document.getElementById("result"); res.style.display="block"; res.appendChild(a);
  document.getElementById("buttons").appendChild(button("Restart", ()=>location.reload(), "secondary"));
}

/* ===== MAIN FLOW (two reflections, 3 waves, name usage) ===== */
function next(){
  if (mainFlowLocked) return; mainFlowLocked=true; setTimeout(()=>mainFlowLocked=false,150);
  stopTimer();
  stepIndex++; setProgress();

  switch(stepIndex){
    // Morning / Ground
    case 1: {
      const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
      render({ text:"üíß Drink water" + her, subtext:`<span class="pill">2 minutes</span>` }); startTimer(2, next);
      break;
    }
    case 2: render({ text:"üßò‚Äç‚ôÄÔ∏è Sit silently", subtext:`<span class="pill">2 minutes</span>` }); startTimer(2, next); break;
    case 3: render({ text:"üå¨Ô∏è Deep breathing (6 times)", subtext:`<span class="note">Inhale 4, hold 2, exhale 6.</span>`, buttons:[{label:"Done", action:next}] }); break;
    case 4:
      render({ text:"üö∂‚Äç‚ôÄÔ∏è Morning walk or sit quietly", subtext:`<span class="pill">15‚Äì25 minutes</span>` });
      document.getElementById("buttons").appendChild(button("Walk 15 min", ()=>startTimer(15,next)));
      document.getElementById("buttons").appendChild(button("Walk 25 min", ()=>startTimer(25,next)));
      document.getElementById("buttons").appendChild(button("Sit quietly", next, "secondary"));
      break;
    case 5:
      if (currentAffirmationIx < affirmationsArabic.length){
        showAffirmations(next);
      } else { next(); }
      break;
    case 6: render({ text:"üéß Morning calm audio", subtext:`<span class="pill">5 minutes</span>` }); startTimer(5, next); break;

    // Spiritual
    case 7: render({ text:"üìñ Quran memorization", subtext:`<span class="pill">15 minutes</span>` }); startTimer(15, next); break;
    case 8: render({ text:"üìñ Quran reading + Adkar Sabah", subtext:`<span class="pill">15 minutes</span>` }); startTimer(15, ()=>askReflection("morning", next)); break;

    // Planning + Dice
    case 9:
      render({ text:"‚è±Ô∏è Gentle planning", subtext:`Check schedule, calculate time, reserve rest, choose focus sessions` });
      showPlanningForm(()=>{ addNote({type:"planning", title:"Gentle planning", content:"Completed"}); next(); });
      break;
    case 10:
      render({ text:"üé≤ Roll dice to split the focus block", subtext:`Dice determines % allocation for all selected subjects`, showDice:true,
        buttons:[{label:"Roll Dice", action:()=>{
          buildSessionsFromDice();
          distributeWaves();
          const alloc = Object.keys(diceResult).map(n=>`<span class="pill">${n}: ${diceResult[n]}%</span>`).join(" ");
          render({ text:"‚úÖ Dice results saved", resultHTML:`<div class="kpi">${alloc}<span class="pill">Total hours: ${focusHours}h</span></div>`,
            buttons:[{label:"Continue", action: next}] });
        }}]
      });
      break;

    // Wave 1: Morning focus (after Quran)
    case 11:
      if (waves.morning.length===0) { next(); break; }
      runWave(waves.morning, next);
      break;

    // Mini break
    case 12: render({ text: randomEnergy(), buttons:[{label:"Next", action: next}] }); break;

    // Lunch
    case 13: render({ text:"üçΩÔ∏è Lunch break", subtext:`<span class="pill">20‚Äì30 minutes</span>`, buttons:[{label:"Start 25 min", action:()=>startTimer(25, next)},{label:"Skip", variant:"secondary", action: next}] }); break;

    // Wave 2: Afternoon focus + reflection
    case 14:
      if (waves.afternoon.length===0) { askReflection("afternoon", next); break; }
      runWave(waves.afternoon, ()=> askReflection("afternoon", next));
      break;

    // Writing + research (outside focus waves)
    case 15: render({ text:"‚úçÔ∏è Writing: reflect on people who look down on themselves", subtext:`<span class="pill">25‚Äì50 minutes</span>` });
             startTimer(30, next); break;
    case 16: render({ text:"üíª Research: required tasks/projects (job-related)", subtext:`<span class="pill">25‚Äì50 minutes</span>` });
             startTimer(30, next); break;

    // Mood changer block
    case 17: render({ text:"üå¨Ô∏è Stretch and breathe", subtext:`<span class="pill">5 minutes</span>` }); startTimer(5, next); break;
    case 18: render({ text:"üçé Eat fruit / nuts / drink water", buttons:[{label:"Done", action: next}] }); break;
    case 19: render({ text:"üéß Listen to relaxing audio or podcast", buttons:[{label:"Done", action: next}] }); break;

    // Wave 3: Night focus
    case 20:
      if (waves.night.length===0) { next(); break; }
      runWave(waves.night, next);
      break;

    case 21: {
      const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
      render({ text:"‚ú® Affirmation review" + her, buttons:[{label:"Done", action: next}] });
      break;
    }

    // Journaling & Closing
    case 22: render({ text:"üìù Journal: one challenge and solution" }); journalingForm("One challenge and solution", next); break;
    case 23: render({ text:"üìù Journal: 3 things done well today" }); journalingForm("3 things done well", next); break;
    case 24: render({ text:"üìù Reflection: mood, resistance, energy levels" }); journalingForm("Mood, resistance, energy", next); break;
    case 25: {
      const her = dayMeta.userProfile?.name ? `, ${dayMeta.userProfile.name}` : "";
      render({ text:"üéâ Congratulate yourself for completing focus sessions" + her, buttons:[{label:"Done", action: next}] });
      break;
    }
    case 26: render({ text:"üåë End-of-day message & self-reflection: gratitude / lessons / plan tomorrow" }); endOfDayForm(()=>showDownload()); break;
    default: showDownload(); break;
  }
}

/* ===== START ===== */
(function init(){
  // Profile first, then step 1
  askProfile(()=>{ stepIndex = 0; next(); });
})();
</script>
</body>
</html>